<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>WebLinks - 网页收藏</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
<div class="max-w-4xl mx-auto p-4 space-y-4">

  <h1 class="text-2xl font-bold">网页收藏 (WebLinks)</h1>

  <!-- 搜索 -->
  <input
    id="searchInput"
    class="w-full p-2 border rounded"
    placeholder="简码 ｜ -名称 ｜ =URL"
  />

  <!-- URL 参数输入 -->
  <input
    id="paramInput"
    class="w-full p-2 border rounded"
    placeholder="参数（可选）：打开链接时替换 %s"
  />

  <!-- 添加 / 编辑 -->
  <div class="grid grid-cols-5 gap-2">
    <input id="codeInput" class="p-2 border rounded" placeholder="简码" />
    <input id="titleInput" class="p-2 border rounded col-span-11" placeholder="网页名称" />
    <input id="urlInput" class="p-2 border rounded col-span-12" placeholder="URL" />
  </div>

  <div class="flex justify-between gap-2">
    <div>
      <button id="exportBtn" class="px-3 py-2 bg-green-600 text-white rounded">导出</button>
      <button id="importAppendBtn" class="px-3 py-2 bg-blue-600 text-white rounded">追加导入</button>
      <button id="importBtn" class="px-3 py-2 bg-gray-400 text-white rounded cursor-not-allowed" disabled>覆盖导入</button>
      <input id="importFile" type="file" accept=".json" class="hidden" />
    </div>
    <div>
      <button id="cancelBtn" class="px-4 py-2 bg-gray-400 text-white rounded hidden">取消</button>
      <button id="saveBtn" class="px-4 py-2 bg-blue-600 text-white rounded">添加</button>
    </div>
  </div>

  <div id="infoMessage" class="w-full text-center text-sm hidden mt-2 p-2 rounded-md"></div>
  <!-- 列表 -->
  <ul id="list" class="space-y-2"></ul>
  <div id="loadMore" class="text-center text-gray-500 py-4 hidden">下滑加载更多…</div>

</div>

<script>
/* ========= DOM ========= */
const listEl = document.getElementById("list")
const loadMore = document.getElementById("loadMore")
const searchInput = document.getElementById("searchInput")
const paramInput = document.getElementById("paramInput")
const saveBtn = document.getElementById("saveBtn")
const cancelBtn = document.getElementById("cancelBtn")
const codeInput = document.getElementById("codeInput")
const titleInput = document.getElementById("titleInput")
const urlInput = document.getElementById("urlInput")
const exportBtn = document.getElementById("exportBtn")
const importBtn = document.getElementById("importBtn")
const importAppendBtn = document.getElementById("importAppendBtn")
const importFile = document.getElementById("importFile")

/* ========= 数据 ========= */
const BOOKMARK_KEY = "bookmarks"
const CLICKLOG_KEY = "clickLogs"
const EXPORTED_FLAG = "true"
const COUNT_INTERVAL_KEY = "clickInterval"

let clickInterval = parseInt(localStorage.getItem(COUNT_INTERVAL_KEY)) || 3600000 // ms

let bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY)) || [
  {id:"wlks", code:"wlks", title:"WebLinks - funhuman", url:"https://funhuman.github.io/wlks", clickCount:0, lastCounted:0, updatedAt:Date.now()},
]
let clickLogs = JSON.parse(localStorage.getItem(CLICKLOG_KEY)) || []

function saveData() {
  localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks))
  localStorage.setItem(CLICKLOG_KEY, JSON.stringify(clickLogs))
  localStorage.setItem(COUNT_INTERVAL_KEY, clickInterval)
}

/* ========= 工具 ========= */
const uid = () => Math.random().toString(36).slice(2, 9)
const formatISO = ts => {
  const d = new Date(ts)
  const p = n=>String(n).padStart(2,"0")
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`
}
const formatTime = ts => formatISO(ts).replace("T"," ")
let timeoutId = null; // 用于保存定时器ID
function showInfoMessage(type, message) {
  const infoMessageElement = document.getElementById("infoMessage");
  if (type === 1) {
    infoMessageElement.className = "bg-green-100 text-green-800 border-l-4 border-green-500 p-2 rounded-md";
  } else if (type === 2) {
    infoMessageElement.className = "bg-red-100 text-red-800 border-l-4 border-red-500 p-2 rounded-md";
  }
  infoMessageElement.textContent = message;
  infoMessageElement.classList.remove("hidden");
  // 如果有正在运行的定时器，先清除
  if (timeoutId) {
    clearTimeout(timeoutId);
  }
  // 10秒后自动隐藏提示信息
  timeoutId = setTimeout(() => {
    infoMessageElement.classList.add("hidden");
  }, 10000);
}
function showSuccessMessage(message) {showInfoMessage(1, message)}
function showFailMessage(message) {showInfoMessage(2, message)}

/* ========= 导出 / 导入 ========= */
exportBtn.onclick = () => {
  const exportBookmarks = bookmarks.map(b => ({
    ...b,
    updatedAt: formatISO(b.updatedAt),
    lastCounted: b.lastCounted ? formatISO(b.lastCounted) : null
  }));
  const exportClickLogs = clickLogs.map(c => ({
    ...c,
    clickedAt: formatISO(c.clickedAt)
  }));
  const data = { config: { clickInterval }, bookmarks: exportBookmarks, clickLogs: exportClickLogs };

  const jsonStr = JSON.stringify(data, null, 2);
  const now = new Date();
  const pad = n => String(n).padStart(2, "0");
  const fileName = `weblinksdata_${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.json`;

  const blob = new Blob([jsonStr], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  a.click();
  unlockImport();
};

function unlockImport() {
  importBtn.disabled = false
  importBtn.classList.remove("bg-gray-400","cursor-not-allowed")
  importBtn.classList.add("bg-orange-600")
  importBtn.textContent = "覆盖导入"
  localStorage.setItem(EXPORTED_FLAG, "true");
}

function lockImport() {
  importBtn.disabled = true
  importBtn.classList.remove("bg-orange-600")
  importBtn.classList.add("bg-gray-400","cursor-not-allowed")
  importBtn.textContent = "覆盖导入（需先导出）"
  localStorage.setItem(EXPORTED_FLAG, "false");
}

if(localStorage.getItem(EXPORTED_FLAG)==="true") unlockImport()

/* ========= 导入（覆盖） ========= */
importBtn.onclick = () => {
  if(localStorage.getItem(EXPORTED_FLAG) !== "true") {
    showFailMessage("请先导出数据，再导入。");
    return;
  }
  importFile.dataset.mode = "overwrite"; // 设置为覆盖模式
  importFile.click();
}

/* ========= 导入（追加） ========= */
importAppendBtn.onclick = () => {
  importFile.dataset.mode = "append"; // 设置为追加模式
  importFile.click();
}

importFile.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      const importedBookmarks = data.bookmarks || [];
      const importedClickLogs = data.clickLogs || [];

      // 判断是覆盖导入还是追加导入
      if (importFile.dataset.mode === "overwrite") {
        // 覆盖导入
        bookmarks = importedBookmarks.map(b => ({
          ...b,
          updatedAt: Date.now(),
          lastCounted: b.lastCounted ? new Date(b.lastCounted).getTime() : 0
        }));
        clickLogs = importedClickLogs.map(c => ({
          ...c,
          clickedAt: new Date(c.clickedAt).getTime()
        }));
      } else if (importFile.dataset.mode === "append") {
        // 追加导入
        importedBookmarks.forEach(b => {
          const existingBookmark = bookmarks.find(bookmark => bookmark.id === b.id);
          if (existingBookmark) {
            // 合并点击次数
            existingBookmark.clickCount += b.clickCount;
            existingBookmark.updatedAt = Date.now();
          } else {
            // 新增书签
            bookmarks.push({...b, updatedAt: Date.now()});
          }
        });

        importedClickLogs.forEach(log => {
          clickLogs.push(log);
        });
      }

      if (data.config && data.config.clickInterval) clickInterval = data.config.clickInterval;
      saveData();
      render();
      showSuccessMessage("导入成功！");
    } catch (err) {
      showFailMessage("导入失败：" + err);
    }
  };
  reader.readAsText(file);
};

/* ========= 渲染 ========= */
let visibleCount = 20
function render(){
  lockImport()
  const kw = searchInput.value.trim().toLowerCase()
  let list = bookmarks
  if(kw.startsWith("-")) list = bookmarks.filter(b=>b.title.toLowerCase().includes(kw.slice(1)))
  else if(kw.startsWith("=")) list = bookmarks.filter(b=>b.url.toLowerCase().includes(kw.slice(1)))
  else if(kw) list = bookmarks.filter(b=>b.code.toLowerCase().includes(kw))
  list = list.sort((a,b)=>b.clickCount!==a.clickCount?b.clickCount-a.clickCount:b.updatedAt-a.updatedAt)
  const show = kw?list:list.slice(0,visibleCount)
  listEl.innerHTML = ""
  show.forEach(b=>{
    const li=document.createElement("li")
    li.className="bg-white p-3 rounded shadow flex justify-between items-center cursor-pointer hover:bg-gray-50"
    li.innerHTML=`<div class="flex-1 truncate">
      <div class="font-semibold">${b.code} · ${b.title} ${b.url.includes("%s") ? 
      '<span class="inline-flex items-center rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 inset-ring inset-ring-indigo-700/10">%</span>' 
      : ''}</div>
      <div class="text-sm text-gray-500 truncate">${b.url}</div>
      <div class="text-xs text-gray-400">点击 ${b.clickCount} · ${formatTime(b.updatedAt)}</div>
    </div>
    <div class="flex gap-2 ml-2">
      <button class="open px-2 py-1 bg-green-600 text-white rounded">打开</button>
      <button class="edit px-2 py-1 bg-yellow-500 text-white rounded">编辑</button>
    </div>`
    li.onclick = e => {
      if(e.ctrlKey||e.metaKey){ countClick(b); return }
      if(e.target.classList.contains("open")||e.target.classList.contains("edit")) return
      li.querySelector(".open").click()
    }
    li.querySelector(".open").onclick = e=>{ e.stopPropagation(); openBookmark(b) }
    li.querySelector(".edit").onclick = e=>{ e.stopPropagation(); editBookmark(b) }
    listEl.appendChild(li)
  })
  loadMore.classList.toggle("hidden", kw || visibleCount>=list.length)
}

/* ========= 打开 + 计数 + 参数替换 ========= */
function openBookmark(b){
  const param = paramInput.value.trim()
  let url = b.url
  if(param) url = url.replace(/%s/g, encodeURIComponent(param))
  window.open(url,"_blank")
  countClick(b)
}

function countClick(b){
  const now = Date.now()
  if(!b.lastCounted || now-b.lastCounted >= clickInterval){
    b.clickCount++
    b.lastCounted = now
    b.updatedAt = now
    clickLogs.push({bookmarkId:b.id, clickedAt:now, count:1})
    saveData()
    render()
  }
}

/* ========= 编辑 ========= */
let editing = null
saveBtn.onclick = ()=>{
  const code = codeInput.value.trim()
  const title = titleInput.value.trim()
  const url = urlInput.value.trim()
  if(!code||!title||!url) return showFailMessage("请填写完整")
  if(editing){
    Object.assign(editing,{code,title,url,updatedAt:Date.now()})
  } else {
    bookmarks.push({id:uid(), code, title, url, clickCount:0,lastCounted:0,updatedAt:Date.now()})
  }
  resetForm()
  saveData()
  render()
}

function editBookmark(b){
  editing = b
  codeInput.value = b.code
  titleInput.value = b.title
  urlInput.value = b.url
  saveBtn.textContent="修改"
  cancelBtn.classList.remove("hidden")
}

function resetForm(){
  editing=null
  codeInput.value = titleInput.value = urlInput.value = ""
  saveBtn.textContent="添加"
  cancelBtn.classList.add("hidden")
}

cancelBtn.onclick = resetForm

/* ========= 搜索 & 下滑加载 ========= */
searchInput.oninput = ()=>{ visibleCount=20; render() }
window.onscroll = ()=>{
  if(innerHeight+scrollY>=document.body.offsetHeight-50){
    visibleCount+=20
    render()
  }
}

/* ========= 初始渲染 ========= */
render()
</script>
</body>
</html>
